<!-- 
Coding Credits:

For the purposes of acknowledgement, this HTML structure was inspired by the following tutorial:
https://youtu.be/Z1RJmh_OqeA
-->

{% extends "base.html" %}
{% block title %}Form{% endblock %}

{% block content %}

{% if not form %}
  <p>No active form available.</p>
{% else %}

<h1>{{ form.title }}</h1>
<p>{{ form.description }}</p>

<div id="pageMeta" data-form-version-id="{{ form_version.form_version_id if form_version else 0 }}"></div>

<div style="display:flex; gap:24px; align-items:flex-start;">

  <div style="flex:2; min-width:320px;">


    {% if session.get("role_name") == "admin" %}
      <div style="margin-bottom:14px;">
        <a href="{{ url_for('editform') }}"
           style="display:inline-block; padding:8px 12px; border:1px solid #999; text-decoration:none;">
          Edit Form
        </a>
      </div>
    {% endif %}

    <form method="POST">

      {% for q in questions %}
        <div id="wrap_{{ q.question_version_id }}" style="margin-bottom:20px;">
          <label>
            <strong>{{ q.prompt_text }}</strong>
            {% if q.is_required %}*{% endif %}
          </label><br>

          {% if q.response_type == "text" %}
            <input
              type="text"
              name="q_{{ q.question_version_id }}"
              id="q_{{ q.question_version_id }}"
              {% if q.is_required %}required{% endif %}
              data-required="{% if q.is_required %}1{% else %}0{% endif %}"
              style="width:100%; padding:8px;"
            >

          {% elif q.response_type == "number" %}
            <input
              type="number"
              name="q_{{ q.question_version_id }}"
              id="q_{{ q.question_version_id }}"
              {% if q.is_required %}required{% endif %}
              data-required="{% if q.is_required %}1{% else %}0{% endif %}"
              style="width:100%; padding:8px;"
            >

          {% elif q.response_type == "rating" %}
            <input
              type="number"
              min="1"
              max="5"
              name="q_{{ q.question_version_id }}"
              id="q_{{ q.question_version_id }}"
              {% if q.is_required %}required{% endif %}
              data-required="{% if q.is_required %}1{% else %}0{% endif %}"
              style="width:100%; padding:8px;"
            >

          {% elif q.response_type == "select" %}
            <select
              name="q_{{ q.question_version_id }}"
              id="q_{{ q.question_version_id }}"
              {% if q.is_required %}required{% endif %}
              data-required="{% if q.is_required %}1{% else %}0{% endif %}"
              style="width:100%; padding:8px;"
            >
              <option value="">-- Please select --</option>
              {% for opt in q.options %}
                <option value="{{ opt.option_value }}">{{ opt.option_label }}</option>
              {% endfor %}
            </select>

          {% elif q.response_type == "multi_select" %}
            <div id="q_{{ q.question_version_id }}">
              {% for opt in q.options %}
                <label style="display:block; margin:4px 0;">
                  <input
                    type="checkbox"
                    name="q_{{ q.question_version_id }}"
                    value="{{ opt.option_value }}"
                  >
                  {{ opt.option_label }}
                </label>
              {% endfor %}
            </div>

          {% else %}
            <input
              type="text"
              name="q_{{ q.question_version_id }}"
              id="q_{{ q.question_version_id }}"
              placeholder="Unsupported question type: {{ q.response_type }}"
              style="width:100%; padding:8px;"
            >
          {% endif %}

          {% if q.help_text %}
            <small>{{ q.help_text }}</small>
          {% endif %}
        </div>
      {% endfor %}

      <button type="submit">Submit</button>
    </form>

  </div>

  <div style="flex:1; min-width:260px; border:1px solid #ccc; padding:12px;">
    <h3 style="margin-top:0;">Notes (not saved)</h3>
    <p style="margin-top:-6px;">
      You can type anything here. This will not be submitted or stored.
    </p>

    <textarea
      id="notesBox"
      placeholder="Write notes here..."
      style="width:100%; height:320px; padding:10px; resize:vertical;"
    ></textarea>

    <div style="margin-top:10px;">
      <button type="button" onclick="clearNotes()">Clear</button>
    </div>
  </div>

</div>

<script>
  function clearNotes() {
    const box = document.getElementById("notesBox");
    if (box) box.value = "";
  }
</script>

<script>
  const formVersionId = Number(
    document.getElementById("pageMeta")?.dataset.formVersionId || 0
  );

  let branchingRules = [];

  function _norm(v) {
    return String(v == null ? "" : v).trim().toLowerCase();
  }

  function getValueForQ(qvid) {
    const el = document.getElementById("q_" + qvid);
    if (!el) return null;

    if (el.tagName === "DIV") {
      const checked = el.querySelectorAll('input[type="checkbox"]:checked');
      return Array.from(checked).map(cb => cb.value);
    }

    // For <select>, return the option value (what is submitted)
    return el.value;
  }

  function getLabelForQ(qvid) {
    const el = document.getElementById("q_" + qvid);
    if (!el) return "";
    if (el.tagName === "SELECT") {
      const idx = el.selectedIndex;
      if (idx >= 0 && el.options && el.options[idx]) {
        return String(el.options[idx].text || "").trim();
      }
    }
    return "";
  }

  function evalRule(rule) {
    const val = getValueForQ(rule.source);
    const label = getLabelForQ(rule.source);

    if (rule.operator === "is_empty") {
      return val == null || (Array.isArray(val) ? val.length === 0 : String(val).trim() === "");
    }
    if (rule.operator === "is_not_empty") {
      return !(val == null || (Array.isArray(val) ? val.length === 0 : String(val).trim() === ""));
    }

    if (Array.isArray(val)) {
      if (rule.operator === "in") {
        const cmp = String(rule.compare_option_value ?? rule.compare_text ?? "");
        if (val.includes(cmp)) return true;
        return val.map(_norm).includes(_norm(cmp));
      }
      if (rule.operator === "not_in") {
        const cmp = String(rule.compare_option_value ?? rule.compare_text ?? "");
        if (val.includes(cmp)) return false;
        return !val.map(_norm).includes(_norm(cmp));
      }
      if (rule.operator === "equals") {
        const cmp = String(rule.compare_option_value ?? rule.compare_text ?? "");
        if (val.length === 1 && val[0] === cmp) return true;
        return val.length === 1 && _norm(val[0]) === _norm(cmp);
      }
      if (rule.operator === "not_equals") {
        const cmp = String(rule.compare_option_value ?? rule.compare_text ?? "");
        if (val.length === 1 && val[0] === cmp) return false;
        return !(val.length === 1 && _norm(val[0]) === _norm(cmp));
      }
      return false;
    }

    const s = (val == null) ? "" : String(val);
    const cmpVal = String(rule.compare_option_value ?? "");
    const cmpText = String(rule.compare_text ?? "");

    // Be tolerant: match either stored option_value or stored option_label.
    // This avoids "it never shows" when older rows stored labels rather than values.
    if (rule.operator === "equals") {
      return (cmpVal && s === cmpVal) || (cmpText && label === cmpText) || (cmpVal && label === cmpVal);
    }
    if (rule.operator === "not_equals") {
      return !((cmpVal && s === cmpVal) || (cmpText && label === cmpText) || (cmpVal && label === cmpVal));
    }
    if (rule.operator === "contains") return s.includes(String(rule.compare_text ?? ""));
    return false;
  }

  function applyBranching() {
    const wraps = Array.from(document.querySelectorAll('[id^="wrap_"]'));
    const order = wraps.map(w => Number(String(w.id).replace("wrap_", "")));
    const idxOf = new Map(order.map((qvid, i) => [qvid, i]));

    for (const w of wraps) {
      w.style.display = "";
    }

    const targetToRules = new Map();
    for (const r of branchingRules) {
      if (r.action !== "show") continue;
      if (!targetToRules.has(r.target)) targetToRules.set(r.target, []);
      targetToRules.get(r.target).push(r);
    }

    for (const [target, rules] of targetToRules.entries()) {
      const wrap = document.getElementById("wrap_" + target);
      if (!wrap) continue;

      let visible = false;

      rules.sort((a,b)=>Number(a.priority||0)-Number(b.priority||0));

      for (const rule of rules) {
        if (evalRule(rule)) {
          visible = true;
          break;
        }
      }

      wrap.style.display = visible ? "" : "none";

      if (!visible) {
        const input = document.getElementById("q_" + target);
        if (input) {
          if (input.tagName === "DIV") {
            const boxes = input.querySelectorAll('input[type="checkbox"]');
            boxes.forEach(cb => cb.checked = false);
          } else if (input.tagName === "SELECT") {
            input.value = "";
          } else {
            input.value = "";
          }
          if (input.tagName !== "DIV") input.required = false;
        }
      } else {
        const input = document.getElementById("q_" + target);
        if (input && input.tagName !== "DIV") {
          const req = String(input.getAttribute("data-required") || "0").trim() === "1";
          input.required = req;
        }
      }
    }

    const gotoBySource = new Map();
    for (const r of branchingRules) {
      if (r.action !== "goto") continue;
      if (!gotoBySource.has(r.source)) gotoBySource.set(r.source, []);
      gotoBySource.get(r.source).push(r);
    }

    for (const [source, rules] of gotoBySource.entries()) {
      const sIdx = idxOf.get(Number(source));
      if (sIdx == null) continue;

      let chosenTarget = null;
      rules.sort((a,b)=>Number(a.priority||0)-Number(b.priority||0));

      for (const rule of rules) {
        if (evalRule(rule)) {
          chosenTarget = Number(rule.target);
          break;
        }
      }

      if (chosenTarget == null) continue;

      const tIdx = idxOf.get(chosenTarget);
      if (tIdx == null) continue;
      if (tIdx <= sIdx) continue;

      for (let i = sIdx + 1; i < tIdx; i++) {
        const qvid = order[i];
        const wrap = document.getElementById("wrap_" + qvid);
        if (!wrap) continue;
        if (wrap.style.display === "none") continue;
        wrap.style.display = "none";
        const input = document.getElementById("q_" + qvid);
        if (input) {
          if (input.tagName === "DIV") {
            const boxes = input.querySelectorAll('input[type="checkbox"]');
            boxes.forEach(cb => cb.checked = false);
          } else if (input.tagName === "SELECT") {
            input.value = "";
          } else {
            input.value = "";
          }
        }
      }
    }
  }

  function attachBranchingListeners() {
    const sources = new Set(branchingRules.map(r => r.source));
    for (const qvid of sources) {
      const el = document.getElementById("q_" + qvid);
      if (!el) continue;

      if (el.tagName === "DIV") {
        const boxes = el.querySelectorAll('input[type="checkbox"]');
        boxes.forEach(cb => cb.addEventListener("change", applyBranching));
      } else {
        el.addEventListener("change", applyBranching);
        el.addEventListener("input", applyBranching);
      }
    }
  }

  async function loadBranching() {
    if (!formVersionId) return;
    const res = await fetch(`/api/branching/${formVersionId}`);
    if (!res.ok) return;
    branchingRules = await res.json();
    attachBranchingListeners();
    applyBranching();
  }

  document.addEventListener("DOMContentLoaded", function() {
    loadBranching();
  });
</script>

{% endif %}

{% endblock %}
